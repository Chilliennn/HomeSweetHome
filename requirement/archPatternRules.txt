1. 分层规则（MVVM 结构）
必须严格分三层：View、ViewModel、Model（Service + Repository）。

View：

只能负责布局、样式、路由导航、收集用户输入。

不允许直接访问数据库、不允许直接调用 Supabase / HTTP。

不写业务规则（例如“不允许超过 3 个 pre‑match”、“7 天才能申请”等）。

ViewModel：

是一个 class；负责 UI 需要的 state 和 UI 交互逻辑。

通过构造函数依赖注入 Service，而不是直接访问 Repository 或 DB。

不直接操作 View（不能调 React 组件、不能操作 DOM）。

Service：

实现核心业务规则和流程（pre‑match 限制、关系阶段、AI 风险判断、申请流程等）。

可以组合多个 Repository，决定“先查什么，再算什么，再存什么”。

Repository：

只负责“怎么存 / 取数据”，例如 Supabase query、表名、字段名。

不包含任何业务规则（不知道 3/5/7 天这些约束）。

2. Data Binding 规则（重点）
所有 ViewModel 属性必须是可观察的（MobX：makeAutoObservable(this)）。

View 必须用观察者组件包裹（MobX：observer(Component)），从而自动订阅 ViewModel。

View 与 ViewModel 的交互方式：

显示数据：只能通过读取 ViewModel 的 observable 属性，例如：

vm.elderProfiles、vm.isLoading、vm.errorMessage、vm.currentUser。

触发动作：只能调用 ViewModel 的方法，例如：

vm.loadElders()、vm.expressInterest()、vm.login()、vm.saveProfile()。

当 Service / Repository 返回数据时，只允许 ViewModel 更新自己的 observable 属性；View 不允许直接 set state 来存业务数据。

View 不关心“什么时候刷新”，只绑定到 ViewModel；ViewModel 状态一变，绑定的 View 自动重渲染，这就是 data binding 的实现。

3. 业务逻辑分配规则
核心业务规则（Domain Logic）必须放在 Service：

例如：

youth active pre‑match ≤ 3，elder ≤ 5。

pre‑match 必须 ≥ 7 天才能申请，>14 天要提示决定是否继续。

动机信 100–1000 字，必填字段不能为空。

Service 返回清晰的结果或错误码，不负责 UI 文案。

ViewModel 负责“呈现逻辑（Presentation Logic）”：

调用 Service 得到结果或错误码。

把结果转换成 UI 需要的 state，例如：

canExpressInterest、canApplyFormally、applicationStatus。

errorMessage（根据错误码决定显示哪一条提示）。

决定是否导航到下一个页面，但不实现路由本身。

View 只根据 ViewModel 的 state 来显示 UI：

不写 if (stage === 'Stage1') 这种业务条件，统一改为读取 ViewModel 暴露的 flag，例如 vm.canStartVideoCall。

不重复实现 validation（所有规则由 Service + ViewModel 统一管理）。

4. 数据访问与调用链规则
典型调用链必须符合：

View → ViewModel → Service → Repository → Supabase / API。

任何 DB / Supabase / HTTP 调用只能出现在 Repository 中。

Service 只能调用 Repository，不直接访问 View 或 ViewModel。

ViewModel 只能调用 Service，不直接访问 Repository / DB。

View 只能访问 ViewModel，不访问 Service / Repository / DB。

示例调用（Adopt Elderly 中表达兴趣）：

View：onPress={() => vm.expressInterest(elderId)}

ViewModel：expressInterest() → matchingService.expressInterest(youthId, elderId)

Service：检查 3/5 名额限制、创建 pre‑match 记录、发送通知 → 调用多个 Repository。

Repository：执行 Supabase query。

5. 状态与复用规则
对于跨多个页面共享的状态（例如 unread count、relationship stage、risk flags），必须集中在对应的 ViewModel 中：

Chat / unread 数 → CommunicationViewModel

关系阶段 / 功能解锁 → StageViewModel

安全风险 / AI 分析 → SafetyViewModel

多个 View（不同页面、甚至移动端和 Web）不能各自维护一份重复状态，而是绑定到同一个 ViewModel 实例或通过 store 共享。

ViewModel 不允许直接持有 React 组件或 View 引用，只能持有数据和方法。

6. 表单与输入绑定规则
表单字段（login、complete profile、application form）必须双向绑定到 ViewModel：

ViewModel 中有 formData 或多个字段属性。

input 控件的 value 绑定到 ViewModel 字段；onChange 调用 ViewModel 的 setter。

基本输入校验：

空值检查、格式检查可在 ViewModel 中完成（影响按钮 disable、错误提示）。

依赖业务规则的校验（例如最小长度、阶段约束）：

由 Service 实现规则，ViewModel 调 Service 并将结果映射为 UI state。